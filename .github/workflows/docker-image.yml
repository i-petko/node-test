name: Docker Image CI


on:
  push:
    branches: [ master ]

jobs:
     

  build:

    runs-on: ubuntu-latest

    steps:
    - uses: actions/checkout@v2
      
    - name: Prepare tag
      run: echo "::set-env name=date::$(date +'%Y-%m-%d')"
    - name: env var
      run: echo ${{ github.sha }}
      
    - name: Build
      # You may pin to the exact commit or the version.
      # uses: docker/build-push-action@ab83648e2e224cfeeab899e23b639660765c3a89
      uses: docker/build-push-action@v1.1.1
      with:
        # Username used to log in to a Docker registry. If not set then no login will occur
        username: petko8
        # Password or personal access token used to log in to a Docker registry. If not set then no login will occur
        password: a187b076-5313-494a-b698-55a99ad337b4
        # Docker repository to tag the image with
        repository: petko8/node-test
        # Comma-delimited list of tags. These will be added to the registry/repository to form the image's tags
        tags: ${{env.date}}
        # Whether to push the image
        push: false

    - name: test
      run: |
        docker run --publish 7000:7000 --detach --name node-test petko8/node-test:${{env.date}} 
        sleep 5
        [[ "$(curl -s localhost:7000)" == "Hello Five!" ]] || exit 1
                
    - name: Push
      uses: docker/build-push-action@v1.1.1
      with:
        # Username used to log in to a Docker registry. If not set then no login will occur
        username: petko8
        # Password or personal access token used to log in to a Docker registry. If not set then no login will occur
        password: a187b076-5313-494a-b698-55a99ad337b4
        # Docker repository to tag the image with
        repository: petko8/node-test
        # Comma-delimited list of tags. These will be added to the registry/repository to form the image's tags
        tags: ${{env.date}}
        # Whether to push the image
        push: true
